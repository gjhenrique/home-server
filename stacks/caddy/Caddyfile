{
	order authenticate before respond
	order authorize before basicauth

	security {
		oauth identity provider google {
			realm google
			driver google
			client_id {$GOOGLE_CLIENT_ID}.apps.googleusercontent.com
			client_secret {$GOOGLE_CLIENT_SECRET}
			scopes openid email profile
		}

		authentication portal myportal {
			crypto default token lifetime 3600
			crypto key sign-verify {$JWT_SHARED_KEY}
			enable identity provider google
			cookie domain {$DOMAIN}
			ui {
				links {
					"My Identity" "/whoami" icon "las la-user"
				}
			}

			transform user {
				match realm google
				regex match email {$ALLOWED_EMAILS}
				action add role authp/user
			}
		}

		authorization policy mypolicy {
			set auth url https://auth.{$DOMAIN}/oauth2/google
			crypto key verify {$JWT_SHARED_KEY}
			allow roles authp/admin authp/user
			validate bearer header
			inject headers with claims
		}

		# Paperless: allow username/password login (web + API). No Caddy JWT required.
		authorization policy paperless_policy {
			bypass uri prefix /
			set auth url https://auth.{$DOMAIN}/oauth2/google
			crypto key verify {$JWT_SHARED_KEY}
			allow roles authp/admin authp/user
			validate bearer header
			inject headers with claims
		}
	}
}

(only_tls) {
	tls {
		dns cloudflare {$CLOUDFLARE_API_TOKEN}
	}
}

(sso) {
	import only_tls
	authorize with mypolicy
}

auth.{$DOMAIN} {
	import only_tls
	authenticate with myportal
}
